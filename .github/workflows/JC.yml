name: Update JCH DATA

on:
  schedule:
    - cron: "0 */5 * * *"
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Fetch and Convert M3U to JSON
        env:
          M3U_URL: ${{ secrets.JCH_API_URL }}
        run: |
          python - <<EOF
          import requests
          import re
          import json
          import os

          if not os.path.exists('JC'):
              os.makedirs('JC')

          url = os.getenv('M3U_URL')
          if not url:
              print("Error: JCH_API_URL secret is not set!")
              exit(1)

          try:
              response = requests.get(url)
              content = response.text
              
     
              items = content.split('#EXTINF:-1')
              channels = []

              for item in items[1:]:
     
                  id_match = re.search(r'tvg-id="(.*?)"', item)
                  name_match = re.search(r',([^\n\r]+)', item)
                  ua_match = re.search(r'user-agent=([^\n\r]+)', item)
                  cookie_match = re.search(r'"cookie":"(.*?)"', item)
                  url_match = re.search(r'(https?://[^\s]+)', item)

                  if url_match:
                      channels.append({
                          "id": id_match.group(1) if id_match else "",
                          "name": name_match.group(1).strip() if name_match else "",
                          "m3u8": url_match.group(1).strip(),
                          "token": cookie_match.group(1) if cookie_match else "",
                          "useragent": ua_match.group(1).strip() if ua_match else ""
                      })

              with open('JC/rest_api.json', 'w', encoding='utf-8') as f:
                  json.dump(channels, f, indent=2, ensure_ascii=False)
              
              print(f"Successfully processed {len(channels)} channels.")

          except Exception as e:
              print(f"An error occurred: {e}")
              exit(1)
          EOF

      - name: Commit and Push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add JC/rest_api.json
          git commit -m "Auto-updated JCH API" || exit 0
          git push
