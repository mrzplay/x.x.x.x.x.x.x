name: Update JCHD DATA
on:
  schedule:
    - cron: "0 */5 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: pip install requests

      - name: Fetch and Convert M3U to JSON
        env:
          M3U_URL: ${{ secrets.JCH_API_URL }}
        run: |
          python - <<EOF
          import requests
          import re
          import json
          import os

          if not os.path.exists('JC'):
              os.makedirs('JC')

          url = os.getenv('M3U_URL')
          try:
              response = requests.get(url)
              content = response.text
              
              items = content.split('#EXTINF')
              channels = []

              for item in items[1:]:
                  id_match = re.search(r'tvg-id="(.*?)"', item)
                  
                  line_parts = item.split('\n')[0]
                  name_match = re.search(r',\s*([^,\n\r]+)$', line_parts)
                  
                  cookie_match = re.search(r'"cookie":"(.*?)"', item)
                  
                  ua_match = re.search(r'user-agent=([^\n\r]+)', item)
                  
                  url_list = re.findall(r'(https?://[^\s\n\r"]+)', item)
                  m3u8_url = url_list[-1] if url_list else ""

                  if m3u8_url:
                      channels.append({
                          "id": id_match.group(1) if id_match else "",
                          "name": name_match.group(1).strip() if name_match else "Unknown",
                          "m3u8": m3u8_url.strip(),
                          "token": cookie_match.group(1) if cookie_match else "",
                          "useragent": ua_match.group(1).strip() if ua_match else ""
                      })

              with open('JC/rest_api.json', 'w', encoding='utf-8') as f:
                  json.dump(channels, f, indent=2, ensure_ascii=False)
              
          except Exception as e:
              pass
          EOF

      - name: Commit and Push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add JC/rest_api.json
          git commit -m "JCH DATA UPDATED" || exit 0
          git push
